name: CI

on:
  push:
    branches:
      - '**'
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint_typecheck_build:
    name: Lint, type-check, and build (monorepo)
    runs-on: ubuntu-latest
    env:
      # Provide required env for provider build-time validation
      SUPABASE_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/waygate
      SESSION_SECRET: dev_session_secret_change_me_please_32_chars_______________
      ENCRYPTION_KEY: dev_encryption_key_change_me_please_32_chars______________
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Type check (all workspaces)
        run: pnpm -r exec tsc --noEmit

      - name: Unit tests (if present)
        run: pnpm -r --workspace-concurrency=1 run -if-present test

      - name: Build (via Turborepo)
        run: pnpm run build

  prisma_checks:
    name: Prisma generate and migrate check
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: waygate
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      SUPABASE_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/waygate
      SESSION_SECRET: dev_session_secret_change_me_please_32_chars_______________
      ENCRYPTION_KEY: dev_encryption_key_change_me_please_32_chars______________
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Generate Prisma Client (provider)
        run: pnpm --filter provider run prisma:generate

      - name: Apply migrations (deploy)
        run: pnpm --filter provider run prisma:migrate:deploy

  integration:
    name: Integration tests (OIDC well-known + token)
    runs-on: ubuntu-latest
    needs: [lint_typecheck_build, prisma_checks]
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: waygate
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      SUPABASE_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/waygate
      SESSION_SECRET: dev_session_secret_change_me_please_32_chars_______________
      ENCRYPTION_KEY: dev_encryption_key_change_me_please_32_chars______________
      SMTP_HOST: sandbox.smtp.mailtrap.io
      SMTP_PORT: '2525'
      SMTP_USER: 9e18d70f376db0
      SMTP_PASS: ${{ secrets.MAILTRAP_PASSWORD }}
      EMAIL_FROM: noreply@example.test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Generate Prisma Client (provider)
        run: pnpm --filter provider run prisma:generate

      - name: Apply migrations (deploy)
        run: pnpm --filter provider run prisma:migrate:deploy

      - name: Ensure example tenant present
        run: |
          pnpm --filter provider exec prisma db execute --stdin <<'SQL'
          insert into "Tenant" (slug, name) values ('example', 'Example Tenant')
          on conflict (slug) do nothing;
          SQL

      - name: Build provider
        run: pnpm --filter provider run build

      - name: Start provider (background)
        run: |
          pnpm --filter provider --silent start &
          echo $! > provider.pid
        env:
          PORT: 3000

      - name: Wait for provider to be ready
        run: |
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:3000/" >/dev/null; then
              echo "Provider is up"; break;
            fi
            echo "Waiting for provider... ($i)"; sleep 1;
          done

      - name: Test .well-known/openid-configuration
        run: |
          curl -fsS "http://localhost:3000/a/example/.well-known/openid-configuration" | tee /tmp/oidc.json
          grep -q '"issuer"' /tmp/oidc.json
          grep -q '"token_endpoint"' /tmp/oidc.json

      - name: Test oauth/token (invalid_client without client_id)
        run: |
          # Expect 400 with { error: "invalid_client" }
          HTTP_STATUS=$(curl -sS -o /tmp/token.json -w "%{http_code}" -X POST \
            -H 'content-type: application/x-www-form-urlencoded' \
            --data 'grant_type=authorization_code&redirect_uri=http%3A%2F%2Flocalhost%3A4000%2Fcallback&code_verifier=dummy' \
            "http://localhost:3000/a/example/oauth/token")
          echo "Status: $HTTP_STATUS"
          cat /tmp/token.json
          test "$HTTP_STATUS" = "400"
          grep -q '"error"' /tmp/token.json
          grep -q 'invalid_client' /tmp/token.json

      - name: Stop provider
        if: always()
        run: |
          if [ -f provider.pid ]; then
            kill $(cat provider.pid) || true
          fi
