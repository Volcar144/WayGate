version: 2.1

jobs:
  e2e:
    docker:
      - image: cimg/node:20.11-browsers
        environment:
          CI: "true"
          SUPABASE_DATABASE_URL: postgresql://postgres:postgres@postgres:5432/waygate
          REDIS_HOST: redis
          REDIS_PORT: "6379"
          SMTP_HOST: mailhog
          SMTP_PORT: "1025"
          EMAIL_FROM: no-reply@example.test
          ENCRYPTION_KEY: dev_encryption_key_change_me_please_32_chars
          SESSION_SECRET: dev_session_secret_change_me_please_32_chars
      - image: postgres:15-alpine
        name: postgres
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: waygate
      - image: redis:7-alpine
        name: redis
      - image: mailhog/mailhog:latest
        name: mailhog
    steps:
      - checkout

      - run:
          name: Enable corepack and pnpm
          command: |
            sudo corepack enable
            sudo corepack prepare pnpm@9.11.0 --activate
            pnpm -v

      - run:
          name: Configure pnpm store path
          command: pnpm config set store-dir ~/.pnpm-store

      - restore_cache:
          keys:
            - v1-pnpm-store-{{ arch }}-{{ checksum "pnpm-lock.yaml" }}
            - v1-pnpm-store-{{ arch }}-

      - run:
          name: Install dependencies
          command: pnpm -w install

      - save_cache:
          key: v1-pnpm-store-{{ arch }}-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.pnpm-store

      - run:
          name: Install Playwright browsers
          command: pnpm exec playwright install

      - run:
          name: Run E2E tests (Playwright)
          command: |
            set +e
            pnpm e2e
            TEST_EXIT=$?
            echo "$TEST_EXIT" > /tmp/test_exit_code
            exit 0

      - run:
          name: Prepare artifacts directories
          command: |
            mkdir -p playwright-report test-results

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: test-results
          destination: test-results

      - store_artifacts:
          path: playwright-report
          destination: playwright-report

      - run:
          name: Fail job if tests failed
          command: |
            EXIT_CODE=$(cat /tmp/test_exit_code || echo 0)
            if [ "$EXIT_CODE" -ne 0 ]; then
              echo "E2E tests failed with exit code $EXIT_CODE"
              exit "$EXIT_CODE"
            fi

workflows:
  e2e:
    jobs:
      - e2e
